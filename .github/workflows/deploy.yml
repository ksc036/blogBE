name: Build and Push Docker Image

on:
  push:
    tags:
      - "dev-*"
      - "prod-*"

jobs:
  docker-build-and-push:
    runs-on: ubuntu-latest
    environment: docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract tag version
        id: extract_tag
        run: echo "TAG=${GITHUB_REF##*/}" >> $GITHUB_ENV

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ksc036/blog-backend:${{ env.TAG }}
            ksc036/blog-backend:latest
  argocd-deploy:
    runs-on: ubuntu-latest
    needs: docker-build-and-push
    environment: argocd
    steps:
      - name: Install Argo CD CLI
        run: |
          curl -sSL -o argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          chmod +x argocd
          sudo mv argocd /usr/local/bin/

      - name: Login to Argo CD
        run: |
          argocd login argocd.ksc036.store \
            --username ${{ secrets.ARGOCD_USERNAME }} \
            --password ${{ secrets.ARGOCD_PASSWORD }} \

      - name: Sync application
        run: |
          echo "=== Current app list ==="
          argocd app list
